:host {
	--_transparency-cell-size: var(--transparency-cell-size, .5em);
	--_transparency-background: var(--transparency-background, transparent);
	--_transparency-darkness: var(--transparency-darkness, 5%);
	--_transparency-grid: var(--transparency-grid,
		repeating-conic-gradient(transparent 0 25%, rgb(0 0 0 / var(--_transparency-darkness)) 0 50%)
		0 0 / calc(2 * var(--_transparency-cell-size)) calc(2 * var(--_transparency-cell-size))
		content-box border-box var(--_transparency-background)
	);

	position: relative;
	display: inline-flex;
	gap: .3em;
	width: fit-content;
	margin: .3em;
	border-radius: .2rem;
}

:host([size="large"]) {
	flex-flow: column;
	inline-size: 11em;
	min-block-size: 6em;
	contain: inline-size;
	container-name: color-swatch;
	container-type: inline-size;
}

slot {
	all: inherit;
	display: contents;
}

#gamut {
	font-size: 80%;

	&:is(:host([size="large"]) *) {
		position: absolute;
		top: 0;
		right: 0;
		margin: .5rem;
	}

	&:not(:host([size="large"]) *) {
		@container style(--details-style: compact) {
			position: absolute;
			font-size: 50%;
			top: 0;
			right: 0;
			margin: .2rem;
		}

		&:is(.static *) {
			align-self: baseline;
		}
	}



	&[style*="--gamut-level: 0"] {
		display: none;
	}
}

[part="info"] {
	margin: 0;
	display: inline-flex;
	display: none;
	gap: .5em;

	&:is(:host([size="large"]) &) {
		display: grid;
		grid-template-columns: max-content auto;
		gap: .1em .2em;
		font-size: max(9px, 80%);
		justify-content: start;

		.coord {
			display: contents;
		}
	}

	.coord {
		display: flex;
		gap: .2em;

		dd {
			margin: 0;
			font-weight: bold;
			font-variant-numeric: tabular-nums;
		}
	}
}

[part="details"] {
	display: flex;
	flex-flow: inherit;
	gap: inherit;

	&.static {
		&:is(:host([size="large"]) *) {
			background: white;
		}
	}

	&:not(:host([size="large"]) *) {
		align-items: baseline;
	}

	@container color-swatch (width <= 5rem) {
		font-size: 80%;
	}

	@container style(--details-style: compact) {
		--_border-color: var(--border-color, color-mix(in oklab, buttonborder 20%, oklab(none none none / 0%)));
		--_pointer-height: var(--pointer-height, .5em);
		--_transition-duration: var(--transition-duration, 400ms);
		--_details-popup-width: var(--details-popup-width, max-content);

		position: absolute;
		left: 50%;
		z-index: 2;
		translate: -50% 0;
		bottom: 100%;
		margin-bottom: calc(var(--_pointer-height) * .8);
		width: var(--_details-popup-width);
		background: canvas;
		border: 1px solid var(--_border-color);
		padding: .6em 1em;
		border-radius: .2rem;
		box-shadow: 0 .05em 1em -.7em black;
		transition: var(--_transition-duration) allow-discrete;
		transition-property: all, display;
		transition-delay: 0s, var(--_transition-duration);
		transform-origin: 50% calc(100% + var(--_pointer-height));

		&[popover] {
			/* Make the triangle pointer visible */
			overflow: visible;

			/* Bring the popover back on the screen */
			position: fixed;
			inset: unset;

			/* And position it relative to the parent swatch */
			left: var(--_popover-left);
			top: var(--_popover-top);
			translate: -50% -100%;
		}

		/* Triangle pointer */
		&::before {
			content: "";
			position: absolute;
			top: 100%;
			left: 50%;
			translate: -50% -50%;
			aspect-ratio: 1;
			height: calc(var(--_pointer-height) * sqrt(2));
			background: inherit;
			border: inherit;
			rotate: -45deg;
			clip-path: polygon(0 0, 0 100%, 100% 100%);
		}

		&:not(:is(:host(:hover), :host(:focus-within), :host(:active), :host(:target), :host([open])) *),
		&:is(:host([open=false]) *) {
			display: none;
			opacity: 0;
			scale: 0;
		}
	}
}

[part="color"] {
	display: flex;
	gap: .2em;
}

[part=label] {
	display: grid;
	grid-template-areas: "label";

	& > * {
		box-sizing: border-box;
		inline-size: 100%;
		font: inherit;

		grid-area: label;

		&:is(input:not(:focus)) {
			border-color: transparent;
		}
	}

	&:has(input:not(:focus))::after {
		/* Icon from https://iconify.design/ */
		content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 56 56"><title>Click to edit</title><path fill="canvastext" d="m53.922 16.202l1.404-1.423c.674-.692.674-1.61.019-2.246l-.45-.449c-.598-.599-1.534-.543-2.17.094l-1.404 1.385Zm-21.505 19.39l3.818-1.703l16.303-16.283l-2.62-2.602l-16.285 16.283l-1.796 3.688c-.15.318.225.767.58.617M5.484 47.908h36.834c3.538 0 5.465-1.853 5.465-5.39V27.02l-3.013 3.013v12.634c0 1.554-.88 2.433-2.433 2.433H5.447c-1.554 0-2.434-.88-2.434-2.433v-15.74c0-1.554.88-2.434 2.434-2.434h30.302l2.826-2.807H5.484C1.947 21.686 0 23.539 0 27.076v15.441c0 3.538 1.947 5.39 5.484 5.39m4.735-10.706c1.33 0 2.415-1.086 2.415-2.396a2.404 2.404 0 0 0-2.415-2.396a2.39 2.39 0 0 0-2.395 2.396a2.4 2.4 0 0 0 2.395 2.396m7.524 0c1.33 0 2.415-1.086 2.415-2.396a2.404 2.404 0 0 0-2.415-2.396a2.393 2.393 0 0 0-2.414 2.396a2.404 2.404 0 0 0 2.414 2.396m7.506 0a2.413 2.413 0 0 0 2.395-2.396a2.4 2.4 0 0 0-2.395-2.396a2.404 2.404 0 0 0-2.415 2.396c0 1.31 1.086 2.396 2.415 2.396"/></svg>');
		grid-area: label;
		align-self: center;
		justify-self: end;

		--_icon-size: 1.3em;
		inline-size: var(--_icon-size);
		block-size: var(--_icon-size);
		padding: 0 .2em .3em 1em;
		background: linear-gradient(to right, transparent, canvas .8em);

		/* Don't block interactions with the underlying element */
		pointer-events: none;
	}
}

slot:not([name]) {
	&::slotted(input) {
		display: flex;
		box-sizing: border-box;
		min-width: 10ch;
		font: inherit;
	}

	&:is(:host([size="large"]) *)::slotted(input) {
		width: 100%;
	}
}

[part="color-wrapper"],
slot[name=swatch]::slotted(*),
#swatch {
	border-radius: inherit;
}

slot[name=swatch]::slotted(*),
#swatch {
	flex: 1;
	display: flex;
	flex-flow: column;
	align-items: center;
	justify-content: center;
	padding: .5em;
	display: flex;
	flex-flow: column;
	flex: 1;
	background:
		linear-gradient(var(--color) 0 100%),
		var(--_transparency-grid);

	&:is(:host([size="large"]) *) {
		min-block-size: 3em;
	}

	&:not(:host([size="large"]) *) {
		display: flex;
		min-inline-size: 2em;
		min-block-size: 1em;
		font-size: 65%;
		flex: 1;
	}
}

slot[name=swatch-content] {
	/* See https://lea.verou.me/blog/2024/contrast-color/ */
	--l: clamp(0, (var(--l-threshold, 0.7) / l - 1) * infinity, 1);
	color: oklch(from var(--color) var(--l) 0 h);
}
